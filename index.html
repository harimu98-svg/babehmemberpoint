<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Babeh Barbershop Membercard Point</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" href="logo.jpg" type="image/jpeg">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Material Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/material-tailwind@2.1.5/css/material-tailwind.min.css" rel="stylesheet">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #7b3aed;
            --primary-light: #9d6af5;
            --primary-dark: #5a2db2;
        }
        
        body {
            background-color: #f5f0ff;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        .bg-purple-doff {
            background-color: #f5f0ff;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        @media (min-width: 768px) {
            .modal-content {
                width: 95%;
            }
        }
        
        .rounded-custom {
            border-radius: 12px;
        }
        
        .btn-yellow {
            background-color: #fbbf24;
            color: #78350f;
        }
        
        .btn-yellow:hover {
            background-color: #f59e0b;
        }
        
        .btn-blue {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-blue:hover {
            background-color: #2563eb;
        }
        
        .btn-green {
            background-color: #10b981;
            color: white;
        }
        
        .btn-green:hover {
            background-color: #059669;
        }
        
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .pagination-btn {
            padding: 8px 16px;
            margin: 0 4px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        
        .pagination-btn.active {
            background-color: #7b3aed;
            color: white;
            border-color: #7b3aed;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-inactive {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .status-migrated {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c4b5fd;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6;
        }
        
        /* Toast Notification - Front Layer */
        #toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999 !important;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-left: 5px solid #7b3aed;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-success {
            border-left-color: #10b981;
        }
        
        .toast-error {
            border-left-color: #ef4444;
        }
        
        .toast-warning {
            border-left-color: #f59e0b;
        }
        
        .toast-info {
            border-left-color: #3b82f6;
        }
       /* ULTRA COMPACT FOR ANDROID */
@media (max-width: 768px) {
    /* Mobile-specific adjustments */
    header {
        padding: 12px 16px !important;
        border-radius: 0 0 20px 20px !important;
    }
    
    header .container {
        flex-direction: column !important;
        text-align: center;
        gap: 12px !important;
    }
    
    header img {
        width: 48px !important;
        height: 48px !important;
        border-width: 2px !important;
    }
    
    header h1 {
        font-size: 1.5rem !important;
        margin-bottom: 4px !important;
    }
    
    header p {
        font-size: 0.875rem !important;
    }
    
    
    /* Main container - NO SPACING */
    main.container {
        padding: 8px !important;
    }
    
    /* Section super compact */
    .bg-white.rounded-custom.shadow-lg {
        margin-bottom: 8px !important;
        padding: 12px !important;
        border-radius: 8px !important;
    }
    
    .bg-white h2 {
        margin-bottom: 8px !important;
        font-size: 0.95rem !important;
    }
    
    /* Form fields ultra compact */
    .grid.grid-cols-1.md\:grid-cols-2.gap-6 {
        gap: 8px !important;
    }
    
    label {
        margin-bottom: 4px !important;
        font-size: 0.8rem !important;
    }
    
    select, input {
        padding: 6px 8px !important;
        font-size: 0.85rem !important;
        height: 36px !important;
    }
    
    .mt-4.text-sm {
        margin-top: 6px !important;
        font-size: 0.7rem !important;
    }
    
    /* Action button compact */
    #btn-migrasi {
        padding: 10px !important;
        font-size: 0.9rem !important;
        border-radius: 8px !important;
    }
    
    #btn-migrasi i {
        font-size: 20px !important;
        margin-bottom: 4px !important;
    }
    
    #btn-migrasi span:last-child {
        font-size: 0.7rem !important;
        margin-top: 2px !important;
    }
    
    /* INFO SYSTEM - SUPER COMPACT GRID */
    .grid.grid-cols-2.gap-3 {
        gap: 6px !important;
    }
    
    .bg-purple-50, .bg-yellow-50, .bg-blue-50, .bg-green-50 {
        padding: 8px !important;
        border-radius: 6px !important;
    }
    
    .bg-purple-50 h3, .bg-yellow-50 h3, .bg-blue-50 h3, .bg-green-50 h3 {
        font-size: 0.75rem !important;
        margin-bottom: 4px !important;
        line-height: 1;
    }
    
    .bg-purple-50 p, .bg-yellow-50 p, .bg-blue-50 p, .bg-green-50 p {
        font-size: 0.7rem !important;
        line-height: 1.2 !important;
        margin-bottom: 2px !important;
    }
    
  /* Footer SUPER COMPACT */
footer {
    padding: 10px 12px !important;  /* ↓ dari 20px 16px */
    margin-top: 12px !important;    /* ↓ dari 20px */
    border-radius: 12px 12px 0 0 !important;
}

footer .grid {
    gap: 8px !important;  /* ↓ dari 16px */
}

footer h3 {
    font-size: 0.9rem !important;  /* ↓ dari 1rem */
    margin-bottom: 4px !important;  /* ↓ dari 8px */
    line-height: 1.2 !important;
}

footer p {
    font-size: 0.75rem !important;  /* ↓ dari 0.875rem */
    line-height: 1.2 !important;    /* ↓ dari 1.4 */
    margin-bottom: 2px !important;  /* tambah untuk kurangi jarak line */
}

footer .mt-6.pt-4 {
    margin-top: 8px !important;   /* ↓ dari 16px */
    padding-top: 6px !important;  /* ↓ dari 12px */
    font-size: 0.7rem !important; /* ↓ dari 11px */
    line-height: 1.1 !important;
}

    /* Modal compact */
    .modal-content {
        width: 98% !important;
        max-height: 90vh !important;
        margin: 4px !important;
        border-radius: 12px !important;
    }
    
    .modal-content .p-6 {
        padding: 12px !important;
    }
}
    </style>
    
    <!-- Disable Tailwind CDN warning -->
    <script>
        tailwind.config = {
            corePlugins: {
                preflight: false,
            }
        }
    </script>
</head>
<body class="bg-purple-doff min-h-screen">
    <!-- Header yang lebih compact -->
<header class="bg-gradient-to-r from-purple-700 to-purple-900 text-white py-2 px-3">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <img id="logo" src="logo.jpg" alt="Logo" class="w-8 h-8 rounded-full border-2 border-white">
            <div>
                <h1 class="text-sm font-bold">Babeh Barbershop</h1>
                <p class="text-xs text-purple-200">Membercard Point</p>
            </div>
        </div>
        <div class="text-xs text-right">
            <p><i class="fas fa-store text-xs mr-1"></i><span id="current-outlet">Pilih</span></p>
            <p><i class="fas fa-user-tie text-xs mr-1"></i><span id="current-kasir">Pilih</span></p>
        </div>
    </div>
</header>

    <!-- Main Content -->
    <main class="p-2">
    <!-- Outlet & Kasir Selection -->
    <div class="bg-white rounded-lg shadow p-3 mb-2">
        <h2 class="text-sm font-bold text-purple-800 mb-2"><i class="fas fa-cogs text-xs mr-1"></i>Pengaturan</h2>
        <div class="grid grid-cols-2 gap-2">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Outlet</label>
                <select id="outlet-select" class="w-full p-2 text-xs border border-purple-300 rounded">
                    <option value="">-- Pilih --</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Kasir</label>
                <select id="kasir-select" class="w-full p-2 text-xs border border-purple-300 rounded" disabled>
                    <option value="">-- Pilih --</option>
                </select>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle text-xs mr-1"></i>Pilih outlet & kasir dulu</p>
    </div>

    <!-- Action Button -->
    <div class="bg-white rounded-lg shadow p-3 mb-2">
        <button id="btn-migrasi" class="w-full bg-green-500 text-white p-3 rounded-lg font-bold flex flex-col items-center disabled:opacity-50" disabled>
            <i class="fas fa-exchange-alt text-lg mb-1"></i>
            <span class="text-sm">MIGRASI MEMBERCARD</span>
            <span class="text-xs mt-1">Konversi point lama ke baru</span>
        </button>
    </div>

    <!-- Status Info - SUPER COMPACT -->
    <div class="bg-white rounded-lg shadow p-3 mb-2">
        <h2 class="text-sm font-bold text-purple-800 mb-2"><i class="fas fa-info-circle text-xs mr-1"></i>Informasi</h2>
        <div class="grid grid-cols-2 gap-2">
            <div class="bg-purple-50 p-2 rounded border border-purple-200">
                <h3 class="font-bold text-purple-700 text-xs mb-1">Outlet & Kasir</h3>
                <p class="text-xs"><span id="info-outlet" class="font-semibold">-</span></p>
                <p class="text-xs"><span id="info-kasir" class="font-semibold">-</span></p>
            </div>
            <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                <h3 class="font-bold text-yellow-700 text-xs mb-1">Olsera</h3>
                <p class="text-xs">Total: <span id="info-olsera-count" class="font-bold">-</span></p>
                <p class="text-xs">Migrasi: <span id="info-olsera-migrasi" class="font-bold">-</span></p>
            </div>
            <div class="bg-blue-50 p-2 rounded border border-blue-200">
                <h3 class="font-bold text-blue-700 text-xs mb-1">Digital</h3>
                <p class="text-xs">Total: <span id="info-digital-count" class="font-bold">-</span></p>
                <p class="text-xs">Aktif: <span id="info-digital-active" class="font-bold">-</span></p>
            </div>
            <div class="bg-green-50 p-2 rounded border border-green-200">
                <h3 class="font-bold text-green-700 text-xs mb-1">Konversi</h3>
                <p class="text-xs">Nilai: <span id="info-konversi" class="font-bold">1</span></p>
                <p class="text-xs">Outlet: <span class="text-green-800" id="info-outlet-name">-</span></p>
            </div>
        </div>
    </div>
</main>

  <!-- Footer yang lebih compact -->
<footer class="bg-gradient-to-r from-purple-800 to-purple-900 text-white p-3 mt-3">
    <div class="grid grid-cols-2 gap-3 text-xs">
        <div>
            <p class="font-bold mb-1"><i class="fas fa-map-marker-alt text-xs mr-1"></i>Head Office</p>
            <p class="text-purple-200">Jl. Abdul Ghani, Ciputat</p>
        </div>
        <div>
            <p class="font-bold mb-1"><i class="fas fa-phone-alt text-xs mr-1"></i>Contact</p>
            <p class="text-purple-200">WA: 0822-1001-7083</p>
        </div>
    </div>
    <div class="text-center text-xs text-purple-300 mt-2 pt-2 border-t border-purple-700">
        <p>Babeh Barbershop v1.0</p>
    </div>
</footer>

    <!-- Modal Migrasi -->
    <div id="modal-migrasi" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-green-800"><i class="fas fa-exchange-alt mr-3"></i>Migrasi Membercard</h2>
                    <button id="close-migrasi" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-custom mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="font-semibold text-gray-700">Outlet:</p>
                            <p id="migrasi-outlet" class="text-lg font-bold text-purple-700">-</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Kasir:</p>
                            <p id="migrasi-kasir" class="text-lg font-bold text-purple-700">-</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Customer Lama -->
                        <div>
                            <h3 class="font-bold text-yellow-700 mb-3 text-lg"><i class="fas fa-user-clock mr-2"></i>Customer Lama (Olsera)</h3>
                            <div class="mb-4">
                                <div class="relative">
                                    <input type="text" id="search-customer-lama" placeholder="Cari berdasarkan Nama, No HP, atau ID Member..." class="w-full p-3 pl-10 border border-yellow-300 rounded-custom focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                                    <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                                </div>
                                <button id="search-btn-customer-lama" class="btn-yellow w-full mt-2 px-6 py-3 rounded-custom font-bold">
                                    <i class="fas fa-search mr-2"></i>Cari Customer Lama
                                </button>
                            </div>
                            
                            <div id="customer-lama-result" class="hidden bg-yellow-50 p-4 rounded-custom border border-yellow-200">
                                <h4 class="font-bold text-yellow-800 mb-2">Customer Lama Terpilih:</h4>
                                <p><span class="font-semibold">Nama:</span> <span id="selected-customer-lama-nama">-</span></p>
                                <p><span class="font-semibold">No HP:</span> <span id="selected-customer-lama-phone">-</span></p>
                                <p><span class="font-semibold">ID Member:</span> <span id="selected-customer-lama-id">-</span></p>
                                <p><span class="font-semibold">Outlet:</span> <span id="selected-customer-lama-outlet">-</span></p>
                                <p><span class="font-semibold">Loyalty Points:</span> <span id="selected-customer-lama-points">-</span></p>
                                <p><span class="font-semibold">Status Migrasi:</span> <span id="selected-customer-lama-status" class="status-badge status-pending">-</span></p>
                            </div>
                        </div>
                        
                        <!-- Customer Baru -->
                        <div>
                            <h3 class="font-bold text-blue-700 mb-3 text-lg"><i class="fas fa-user-check mr-2"></i>Customer Baru (Digital)</h3>
                            <div class="mb-4">
                                <div id="customer-baru-auto" class="hidden bg-blue-50 p-4 rounded-custom border border-blue-200 mb-3">
                                    <p class="font-semibold text-blue-800"><i class="fas fa-check-circle mr-2"></i>Customer baru ditemukan otomatis berdasarkan nomor HP lama</p>
                                </div>
                                
                                <div class="relative">
                                    <input type="text" id="search-customer-baru" placeholder="Cari berdasarkan Nama, No WA, atau ID Member..." class="w-full p-3 pl-10 border border-blue-300 rounded-custom focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                                </div>
                                <button id="search-btn-customer-baru" class="btn-blue w-full mt-2 px-6 py-3 rounded-custom font-bold">
                                    <i class="fas fa-search mr-2"></i>Cari Customer Baru
                                </button>
                            </div>
                            
                            <div id="customer-baru-result" class="hidden bg-blue-50 p-4 rounded-custom border border-blue-200">
                                <h4 class="font-bold text-blue-800 mb-2">Customer Baru Terpilih:</h4>
                                <p><span class="font-semibold">Nama:</span> <span id="selected-customer-baru-nama">-</span></p>
                                <p><span class="font-semibold">No WA:</span> <span id="selected-customer-baru-wa">-</span></p>
                                <p><span class="font-semibold">ID Member:</span> <span id="selected-customer-baru-id">-</span></p>
                                <p><span class="font-semibold">Outlet:</span> <span id="selected-customer-baru-outlet">-</span></p>
                                <p><span class="font-semibold">Point Saat Ini:</span> <span id="selected-customer-baru-point">-</span></p>
                                <p><span class="font-semibold">Status:</span> <span id="selected-customer-baru-status" class="status-badge">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Table -->
                <div id="comparison-section" class="hidden">
                    <h3 class="font-bold text-gray-800 mb-4 text-lg"><i class="fas fa-table mr-2"></i>Perbandingan Data Migrasi</h3>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-300 rounded-custom overflow-hidden">
                            <thead class="bg-green-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-green-800 border-b">Data Membercard</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-yellow-800 border-b">Data Lama (Olsera)</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-blue-800 border-b">Data Baru (Digital)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="px-4 py-3 font-semibold text-gray-700">Outlet</td>
                                    <td class="px-4 py-3" id="compare-outlet-lama">-</td>
                                    <td class="px-4 py-3" id="compare-outlet-baru">-</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="px-4 py-3 font-semibold text-gray-700">Nama Customer</td>
                                    <td class="px-4 py-3" id="compare-nama-lama">-</td>
                                    <td class="px-4 py-3" id="compare-nama-baru">-</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="px-4 py-3 font-semibold text-gray-700">Nomor WA/HP</td>
                                    <td class="px-4 py-3" id="compare-phone-lama">-</td>
                                    <td class="px-4 py-3" id="compare-phone-baru">-</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="px-4 py-3 font-semibold text-gray-700">Alamat</td>
                                    <td class="px-4 py-3" id="compare-alamat-lama">-</td>
                                    <td class="px-4 py-3" id="compare-alamat-baru">-</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="px-4 py-3 font-semibold text-gray-700">ID Member</td>
                                    <td class="px-4 py-3" id="compare-id-lama">-</td>
                                    <td class="px-4 py-3" id="compare-id-baru">-</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-semibold text-gray-700">Point Lama</td>
                                    <td class="px-4 py-3" id="compare-point-lama">-</td>
                                    <td class="px-4 py-3" colspan="2"></td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-semibold text-gray-700">Konversi Point</td>
                                    <td class="px-4 py-3" id="compare-konversi">-</td>
                                    <td class="px-4 py-3" colspan="2"></td>
                                </tr>
                                <tr class="bg-green-50">
                                    <td class="px-4 py-3 font-bold text-green-800">POINT BARU</td>
                                    <td class="px-4 py-3 font-bold text-green-800" colspan="2" id="compare-point-baru">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Validation Warning -->
                    <div id="migrasi-warning" class="mt-4 hidden">
                        <div id="already-migrated-warning" class="bg-red-50 p-4 rounded-custom border border-red-200 mb-3 hidden">
                            <p class="font-semibold text-red-800"><i class="fas fa-exclamation-circle mr-2"></i>Customer ini sudah melakukan migrasi sebelumnya. Tidak dapat migrasi ulang.</p>
                        </div>
                        
                        <div id="phone-mismatch-warning" class="bg-yellow-50 p-4 rounded-custom border border-yellow-200 hidden">
                            <p class="font-semibold text-yellow-800"><i class="fas fa-exclamation-triangle mr-2"></i>Nomor WA berbeda antara customer lama dan baru:</p>
                            <p class="text-sm mt-1">Lama: <span id="warning-phone-lama" class="font-bold">-</span></p>
                            <p class="text-sm">Baru: <span id="warning-phone-baru" class="font-bold">-</span></p>
                            <p class="text-sm mt-2">Apakah Anda yakin akan melanjutkan migrasi?</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button id="submit-migrasi" class="btn-green px-8 py-3 rounded-custom font-bold text-lg">
                            <i class="fas fa-paper-plane mr-2"></i>SUBMIT MIGRASI
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button id="close-migrasi-bottom" class="bg-gray-500 text-white px-6 py-3 rounded-custom font-bold hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Tutup
                    </button>
                </div>
            </div>
        </div>
    </modal>

    <!-- Search Results Modal -->
    <div id="modal-search-results" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="search-results-title" class="text-2xl font-bold text-purple-800"></h2>
                    <button id="close-search-results" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="search-results-thead" class="bg-purple-100">
                            <!-- Table headers will be populated here -->
                        </thead>
                        <tbody id="search-results-tbody" class="bg-white divide-y divide-gray-200">
                            <!-- Search results will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="search-results-pagination" class="mt-4 flex justify-center items-center space-x-2">
                    <!-- Pagination will be generated here -->
                </div>
                
                <div class="mt-6 text-center">
                    <button id="close-search-results-bottom" class="bg-gray-500 text-white px-6 py-3 rounded-custom font-bold hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden">
        <div class="flex items-start">
            <div id="toast-icon" class="mr-3 mt-1">
                <i class="fas fa-info-circle text-xl"></i>
            </div>
            <div class="flex-1">
                <p id="toast-title" class="font-bold text-gray-800"></p>
                <p id="toast-message" class="text-sm text-gray-600 mt-1"></p>
            </div>
            <button id="close-toast" class="ml-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-custom shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-700 mb-4"></div>
            <p class="text-gray-700 font-semibold" id="loading-text">Memuat data...</p>
        </div>
    </div>

    <script>
        // =================== KONFIGURASI ===================
        const supabaseUrl = 'https://intzwjmlypmopzauxeqt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImludHp3am1seXBtb3B6YXV4ZXF0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDcxNzkxMiwiZXhwIjoyMDcwMjkzOTEyfQ.Sx_VwOEHbLjVhc3rL96hlIGNkiZ44a4oD9T8DcBzwGI';
        const WAHA_URL = 'https://waha-yetv8qi4e3zk.anakit.sumopod.my.id/api/sendText';
        const WAHA_API_KEY = 'sfcoGbpdLDkGZhKw2rx8sbb14vf4d8V6';
        
        // =================== INISIALISASI ===================
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // =================== VARIABEL GLOBAL ===================
window.selectedOutlet = '';
window.selectedKasir = '';
window.konversiPointValue = 1;  // ← INI YANG PENTING
window.currentSearchPage = 1;
window.searchType = '';
window.searchResults = [];
window.selectedCustomerLama = null;
window.selectedCustomerBaru = null;
        
        // =================== DOM ELEMENTS ===================
        const outletSelect = document.getElementById('outlet-select');
        const kasirSelect = document.getElementById('kasir-select');
        const currentOutletSpan = document.getElementById('current-outlet');
        const currentKasirSpan = document.getElementById('current-kasir');
        const infoOutletSpan = document.getElementById('info-outlet');
        const infoKasirSpan = document.getElementById('info-kasir');
        const btnMigrasi = document.getElementById('btn-migrasi');
        const modalMigrasi = document.getElementById('modal-migrasi');
        const modalSearchResults = document.getElementById('modal-search-results');
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toast-title');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        // =================== INISIALISASI APLIKASI ===================
        document.addEventListener('DOMContentLoaded', function() {
            loadOutlets();
            setupEventListeners();
        });
        
        // =================== SETUP EVENT LISTENERS ===================
        function setupEventListeners() {
            // Outlet selection
            outletSelect.addEventListener('change', async function() {
    window.selectedOutlet = this.value;  // ← UPDATE WINDOW VARIABLE
    currentOutletSpan.textContent = this.options[this.selectedIndex].text;
    infoOutletSpan.textContent = this.options[this.selectedIndex].text;
    
    if (window.selectedOutlet) {
        await loadKasir(window.selectedOutlet);
        await loadSystemInfo();
        btnMigrasi.disabled = false;
        await getKonversiPoint(window.selectedOutlet);  // ← PASTIKAN ADA await
    } else {
        kasirSelect.disabled = true;
        kasirSelect.innerHTML = '<option value="">-- Pilih Kasir --</option>';
        btnMigrasi.disabled = true;
    }
});
            // Kasir selection
            kasirSelect.addEventListener('change', function() {
                selectedKasir = this.value;
                currentKasirSpan.textContent = this.options[this.selectedIndex].text;
                infoKasirSpan.textContent = this.options[this.selectedIndex].text;
                
                document.getElementById('migrasi-outlet').textContent = outletSelect.options[outletSelect.selectedIndex].text;
                document.getElementById('migrasi-kasir').textContent = this.options[this.selectedIndex].text;
            });
            
            // Modal open/close
            btnMigrasi.addEventListener('click', openModalMigrasi);
            document.getElementById('close-migrasi').addEventListener('click', closeModalMigrasi);
            document.getElementById('close-migrasi-bottom').addEventListener('click', closeModalMigrasi);
            document.getElementById('close-search-results').addEventListener('click', closeModalSearchResults);
            document.getElementById('close-search-results-bottom').addEventListener('click', closeModalSearchResults);
            
            // Search functionality
            document.getElementById('search-btn-customer-lama').addEventListener('click', searchCustomerLama);
            document.getElementById('search-btn-customer-baru').addEventListener('click', searchCustomerBaru);
            
            // Submit migrasi
            document.getElementById('submit-migrasi').addEventListener('click', submitMigrasi);
            
            // Toast close
            document.getElementById('close-toast').addEventListener('click', function() {
                toast.classList.add('hidden');
            });
            
            // Search input enter key
            document.getElementById('search-customer-lama').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchCustomerLama();
            });
            
            document.getElementById('search-customer-baru').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchCustomerBaru();
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === modalMigrasi) closeModalMigrasi();
                if (e.target === modalSearchResults) closeModalSearchResults();
            });
        }
        
        // =================== FUNGSI UTAMA ===================
        
        // 1. LOAD OUTLETS
        async function loadOutlets() {
            showLoading('Memuat data outlet...');
            
            try {
                const { data, error } = await supabase
                    .from('outlet')
                    .select('outlet')
                    .order('outlet');
                
                if (error) throw error;
                
                outletSelect.innerHTML = '<option value="">-- Pilih Outlet --</option>';
                
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.outlet;
                        option.textContent = item.outlet;
                        outletSelect.appendChild(option);
                    });
                    
                    showToast('success', 'Data outlet berhasil dimuat', `Total outlet: ${data.length}`);
                } else {
                    showToast('warning', 'Data outlet tidak ditemukan', 'Tambahkan data outlet terlebih dahulu');
                }
            } catch (error) {
                console.error('Error loading outlets:', error);
                showToast('error', 'Gagal memuat data outlet', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 2. LOAD KASIR
        async function loadKasir(outlet) {
            showLoading('Memuat data kasir...');
            
            try {
                const { data, error } = await supabase
                    .from('karyawan')
                    .select('nama_karyawan')
                    .eq('outlet', outlet)
                    .eq('role', 'kasir')
                    .order('nama_karyawan');
                
                if (error) throw error;
                
                kasirSelect.innerHTML = '<option value="">-- Pilih Kasir --</option>';
                kasirSelect.disabled = false;
                
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.nama_karyawan;
                        option.textContent = item.nama_karyawan;
                        kasirSelect.appendChild(option);
                    });
                } else {
                    showToast('warning', 'Data kasir tidak ditemukan', `Tidak ada kasir di outlet ${outlet}`);
                }
            } catch (error) {
                console.error('Error loading kasir:', error);
                showToast('error', 'Gagal memuat data kasir', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 3. LOAD SYSTEM INFO (Auto-load setelah outlet dipilih)
        async function loadSystemInfo() {
            if (!selectedOutlet) return;
            
            try {
                // Hitung membercard_olsera berdasarkan outlet
                const { count: olseraCount } = await supabase
                    .from('membercard_olsera')
                    .select('*', { count: 'exact', head: true })
                    .eq('outlet', selectedOutlet);
                
                // Hitung status migrasi
                const { count: migratedCount } = await supabase
                    .from('membercard_olsera')
                    .select('*', { count: 'exact', head: true })
                    .eq('outlet', selectedOutlet)
                    .eq('status_migrasi', 'Sudah Migrasi');
                
                // Hitung membercard digital berdasarkan outlet
                const { count: digitalCount } = await supabase
                    .from('membercard')
                    .select('*', { count: 'exact', head: true })
                    .eq('outlet', selectedOutlet);
                
                // Hitung status aktif
                const { count: activeCount } = await supabase
                    .from('membercard')
                    .select('*', { count: 'exact', head: true })
                    .eq('outlet', selectedOutlet)
                    .eq('status', 'active');
                
                // Update UI
                document.getElementById('info-olsera-count').textContent = olseraCount || 0;
                document.getElementById('info-olsera-migrasi').textContent = `${migratedCount || 0} dari ${olseraCount || 0} sudah migrasi`;
                document.getElementById('info-digital-count').textContent = digitalCount || 0;
                document.getElementById('info-digital-active').textContent = `${activeCount || 0} dari ${digitalCount || 0} aktif`;
                
            } catch (error) {
                console.error('Error loading system info:', error);
            }
        }
        
        // 4. GET KONVERSI POINT
        async function getKonversiPoint(outlet) {
    try {
        const { data, error } = await supabase
            .from('outlet')
            .select('konversi_point')
            .eq('outlet', outlet.trim())
            .single();
        
        if (error || !data) {
            window.konversiPointValue = 1;  // ← UPDATE WINDOW VARIABLE
            console.warn(`Konversi untuk ${outlet} tidak ditemukan, default=1`);
        } else {
            window.konversiPointValue = parseFloat(data.konversi_point) || 1;  // ← UPDATE WINDOW
            console.log(`Konversi ${outlet}: ${window.konversiPointValue}`);
        }
        
        // Update UI jika element ada
        updateKonversiUI(outlet, window.konversiPointValue);
        
    } catch (error) {
        window.konversiPointValue = 1;  // ← UPDATE WINDOW
        console.error('Error get konversi:', error);
    }
}

// Fungsi untuk update UI
function updateKonversiUI(outlet, value) {
    const konversiElement = document.getElementById('info-konversi');
    const outletElement = document.getElementById('info-outlet-name');
    
    if (konversiElement) konversiElement.textContent = value;
    if (outletElement) outletElement.textContent = outlet;
    
    // Debug log
    console.log(`UI Updated - Outlet: ${outlet}, Konversi: ${value}`);
}
        // 5. SEARCH CUSTOMER LAMA (Dengan filter outlet)
        async function searchCustomerLama() {
            const searchTerm = document.getElementById('search-customer-lama').value.trim();
            searchType = 'customer-lama';
            currentSearchPage = 1;
            
            if (!searchTerm) {
                showToast('warning', 'Masukkan kata kunci pencarian', 'Silakan masukkan nama, nomor HP, atau ID Member');
                return;
            }
            
            if (!selectedOutlet) {
                showToast('warning', 'Pilih outlet terlebih dahulu', 'Silakan pilih outlet sebelum mencari customer');
                return;
            }
            
            showLoading('Mencari customer lama...');
            
            try {
                // FILTER: hanya data dengan outlet yang dipilih, search by name, phone, atau code
                let query = supabase
                    .from('membercard_olsera')
                    .select('*', { count: 'exact' })
                    .eq('outlet', selectedOutlet)  // FILTER OUTLET
                    .or(`name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,code.ilike.%${searchTerm}%`);
                
                const from = (currentSearchPage - 1) * 10;
                const to = from + 9;
                query = query.range(from, to).order('name');
                
                const { data, error, count } = await query;
                
                if (error) throw error;
                
                if (data.length === 0) {
                    showToast('info', 'Customer tidak ditemukan', 'Tidak ada customer lama dengan kata kunci tersebut di outlet ini');
                    return;
                }
                
                searchResults = data;
                displaySearchResults(data, count, 'customer-lama');
                
            } catch (error) {
                console.error('Error searching customer lama:', error);
                showToast('error', 'Gagal mencari customer lama', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 6. SEARCH CUSTOMER BARU (Dengan filter outlet)
        async function searchCustomerBaru() {
            const searchTerm = document.getElementById('search-customer-baru').value.trim();
            searchType = 'customer-baru';
            currentSearchPage = 1;
            
            // Jika ada customer lama terpilih, coba auto-find
            if (selectedCustomerLama && !searchTerm) {
                await findCustomerBaruByPhone(selectedCustomerLama.phone);
                return;
            }
            
            if (!searchTerm) {
                showToast('warning', 'Masukkan kata kunci pencarian', 'Silakan masukkan nama, nomor WA, atau ID Member');
                return;
            }
            
            if (!selectedOutlet) {
                showToast('warning', 'Pilih outlet terlebih dahulu', 'Silakan pilih outlet sebelum mencari customer');
                return;
            }
            
            showLoading('Mencari customer baru...');
            
            try {
                // FILTER: hanya data dengan outlet yang dipilih, search by nama, nomorWA, atau id_member
                let query = supabase
                    .from('membercard')
                    .select('*', { count: 'exact' })
                    .eq('outlet', selectedOutlet)  // FILTER OUTLET
                    .or(`nama.ilike.%${searchTerm}%,nomorWA.ilike.%${searchTerm}%,id_member.ilike.%${searchTerm}%`);
                
                const from = (currentSearchPage - 1) * 10;
                const to = from + 9;
                query = query.range(from, to).order('nama');
                
                const { data, error, count } = await query;
                
                if (error) throw error;
                
                if (data.length === 0) {
                    showToast('info', 'Customer tidak ditemukan', 'Tidak ada customer baru dengan kata kunci tersebut di outlet ini');
                    return;
                }
                
                searchResults = data;
                displaySearchResults(data, count, 'customer-baru');
                
            } catch (error) {
                console.error('Error searching customer baru:', error);
                showToast('error', 'Gagal mencari customer baru', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 7. AUTO-FIND CUSTOMER BARU BY PHONE
        async function findCustomerBaruByPhone(phone) {
            showLoading('Mencari customer baru berdasarkan nomor HP...');
            
            // Convert phone format for search
            let searchPhone = phone;
            if (phone.startsWith('+62')) {
                searchPhone = phone.replace('+62', '62');
            } else if (phone.startsWith('08')) {
                searchPhone = '62' + phone.substring(1);
            } else if (phone.startsWith('628')) {
                searchPhone = phone;
            }
            
            try {
                const { data, error } = await supabase
                    .from('membercard')
                    .select('*')
                    .eq('outlet', selectedOutlet)  // FILTER OUTLET
                    .ilike('nomorWA', `%${searchPhone}%`)
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    document.getElementById('customer-baru-auto').classList.remove('hidden');
                    selectCustomerBaru(data[0]);
                } else {
                    showToast('info', 'Customer baru tidak ditemukan', 'Silakan cari customer baru secara manual');
                    document.getElementById('customer-baru-auto').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error finding customer baru by phone:', error);
                showToast('error', 'Gagal mencari customer baru', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 8. DISPLAY SEARCH RESULTS (Dengan kolom outlet dan status)
        function displaySearchResults(data, totalCount, type) {
            const modal = modalSearchResults;
            const title = document.getElementById('search-results-title');
            const thead = document.getElementById('search-results-thead');
            const tbody = document.getElementById('search-results-tbody');
            
            // Set title
            title.textContent = type === 'customer-lama' 
                ? 'Pilih Customer Lama (Olsera)' 
                : 'Pilih Customer Baru (Digital)';
            
            // Set table headers
            if (type === 'customer-lama') {
                thead.innerHTML = `
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-yellow-800 uppercase">Outlet</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-yellow-800 uppercase">ID Member</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-yellow-800 uppercase">Nama</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-yellow-800 uppercase">Nomor HP</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-yellow-800 uppercase">Loyalty Points</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-yellow-800 uppercase">Status Migrasi</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-yellow-800 uppercase">Aksi</th>
                    </tr>
                `;
            } else {
                thead.innerHTML = `
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase">Outlet</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase">ID Member</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase">Nama</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase">Nomor WA</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase">Point</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-blue-800 uppercase">Aksi</th>
                    </tr>
                `;
            }
            
            // Clear table body
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="${type === 'customer-lama' ? 7 : 7}" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-database text-3xl mb-2 block"></i>
                        <p>Tidak ada data ditemukan</p>
                    </td>
                `;
                tbody.appendChild(row);
            } else {
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    if (type === 'customer-lama') {
                        // Tampilkan status migrasi
                        const statusClass = item.status_migrasi === 'Sudah Migrasi' 
                            ? 'status-migrated' 
                            : item.status_migrasi === 'belum migrasi' 
                                ? 'status-pending'
                                : 'status-pending';
                        const statusText = item.status_migrasi === 'Sudah Migrasi' 
                            ? 'Sudah Migrasi' 
                            : item.status_migrasi === 'belum migrasi'
                                ? 'Belum Migrasi'
                                : 'Belum Migrasi';
                        
                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm">${item.outlet || '-'}</td>
                            <td class="px-4 py-3 text-sm font-bold">${item.code || '-'}</td>
                            <td class="px-4 py-3">
                                <div class="font-medium text-gray-900">${item.name || '-'}</div>
                            </td>
                            <td class="px-4 py-3 text-sm">${item.phone || '-'}</td>
                            <td class="px-4 py-3 text-sm font-bold">${item.loyalty_points || 0}</td>
                            <td class="px-4 py-3">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <button class="btn-yellow px-3 py-1 rounded-custom text-xs font-bold" onclick="selectCustomerLama(${item.id})" ${item.status_migrasi === 'Sudah Migrasi' ? 'disabled style="opacity:0.5; cursor:not-allowed"' : ''}>
                                    <i class="fas fa-check mr-1"></i>${item.status_migrasi === 'Sudah Migrasi' ? 'SUDAH MIGRASI' : 'PILIH'}
                                </button>
                            </td>
                        `;
                    } else {
                        // Tampilkan status membercard
                        const statusClass = item.status === 'active' 
                            ? 'status-active' 
                            : 'status-inactive';
                        
                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm">${item.outlet || '-'}</td>
                            <td class="px-4 py-3 text-sm font-bold">${item.id_member || '-'}</td>
                            <td class="px-4 py-3">
                                <div class="font-medium text-gray-900">${item.nama || '-'}</div>
                            </td>
                            <td class="px-4 py-3 text-sm">${item.nomorWA || '-'}</td>
                            <td class="px-4 py-3 text-sm font-bold">${item.point || 0}</td>
                            <td class="px-4 py-3">
                                <span class="status-badge ${statusClass}">${item.status || 'unknown'}</span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <button class="btn-blue px-3 py-1 rounded-custom text-xs font-bold" onclick="selectCustomerBaru(${item.id})">
                                    <i class="fas fa-check mr-1"></i>PILIH
                                </button>
                            </td>
                        `;
                    }
                    
                    tbody.appendChild(row);
                });
            }
            
            // Generate pagination
            generatePagination('search-results-pagination', currentSearchPage, totalCount, 10, 'search');
            
            // Show modal
            modal.classList.remove('hidden');
        }
        
        // 9. SELECT CUSTOMER LAMA
        window.selectCustomerLama = function(customerId) {
            const customer = searchResults.find(item => item.id === customerId);
            
            if (!customer) return;
            
            selectedCustomerLama = customer;
            
            // Update UI
            document.getElementById('selected-customer-lama-nama').textContent = customer.name || '-';
            document.getElementById('selected-customer-lama-phone').textContent = customer.phone || '-';
            document.getElementById('selected-customer-lama-id').textContent = customer.code || '-';
            document.getElementById('selected-customer-lama-outlet').textContent = customer.outlet || '-';
            document.getElementById('selected-customer-lama-points').textContent = customer.loyalty_points || 0;
            
            // Update status migrasi dengan badge
            const statusElement = document.getElementById('selected-customer-lama-status');
            statusElement.textContent = customer.status_migrasi || 'Belum Migrasi';
            statusElement.className = 'status-badge ' + 
                (customer.status_migrasi === 'Sudah Migrasi' ? 'status-migrated' : 
                 customer.status_migrasi === 'belum migrasi' ? 'status-pending' : 'status-pending');
            
            document.getElementById('customer-lama-result').classList.remove('hidden');
            
            // Close search modal
            closeModalSearchResults();
            
            // Try to find customer baru automatically
            if (customer.phone) {
                findCustomerBaruByPhone(customer.phone);
            }
            
            // Jika customer baru sudah dipilih, show comparison
            if (selectedCustomerBaru) {
                showComparison();
            }
        };
        
        // 10. SELECT CUSTOMER BARU
        window.selectCustomerBaru = function(customerId) {
            const customer = searchResults.find(item => item.id === customerId);
            
            if (!customer) return;
            
            selectedCustomerBaru = customer;
            
            // Update UI
            document.getElementById('selected-customer-baru-nama').textContent = customer.nama || '-';
            document.getElementById('selected-customer-baru-wa').textContent = customer.nomorWA || '-';
            document.getElementById('selected-customer-baru-id').textContent = customer.id_member || '-';
            document.getElementById('selected-customer-baru-outlet').textContent = customer.outlet || '-';
            document.getElementById('selected-customer-baru-point').textContent = customer.point || 0;
            
            // Update status dengan badge
            const statusElement = document.getElementById('selected-customer-baru-status');
            statusElement.textContent = customer.status || 'unknown';
            statusElement.className = 'status-badge ' + 
                (customer.status === 'active' ? 'status-active' : 'status-inactive');
            
            document.getElementById('customer-baru-result').classList.remove('hidden');
            
            // Close search modal
            closeModalSearchResults();
            
            // Jika customer lama sudah dipilih, show comparison
            if (selectedCustomerLama) {
                showComparison();
            }
        };
        
        // 11. SHOW COMPARISON (Dengan validasi)
        function showComparison() {
            if (!selectedCustomerLama || !selectedCustomerBaru) return;
            
            // Calculate new points
            const loyaltyPoints = parseFloat(selectedCustomerLama.loyalty_points) || 0;
            const newPoints = Math.ceil(loyaltyPoints / konversiPointValue);
            
            // Update comparison table
            document.getElementById('compare-outlet-lama').textContent = selectedCustomerLama.outlet || '-';
            document.getElementById('compare-outlet-baru').textContent = selectedCustomerBaru.outlet || '-';
            document.getElementById('compare-nama-lama').textContent = selectedCustomerLama.name || '-';
            document.getElementById('compare-nama-baru').textContent = selectedCustomerBaru.nama || '-';
            document.getElementById('compare-phone-lama').textContent = selectedCustomerLama.phone || '-';
            document.getElementById('compare-phone-baru').textContent = selectedCustomerBaru.nomorWA || '-';
            document.getElementById('compare-alamat-lama').textContent = selectedCustomerLama.address || '-';
            document.getElementById('compare-alamat-baru').textContent = selectedCustomerBaru.alamat || '-';
            document.getElementById('compare-id-lama').textContent = selectedCustomerLama.code || '-';
            document.getElementById('compare-id-baru').textContent = selectedCustomerBaru.id_member || '-';
            document.getElementById('compare-point-lama').textContent = loyaltyPoints;
            document.getElementById('compare-konversi').textContent = konversiPointValue;
            document.getElementById('compare-point-baru').textContent = newPoints;
            
            // VALIDASI 1: Cek status migrasi
            const alreadyMigratedWarning = document.getElementById('already-migrated-warning');
            if (selectedCustomerLama.status_migrasi === 'Sudah Migrasi') {
                alreadyMigratedWarning.classList.remove('hidden');
                document.getElementById('submit-migrasi').disabled = true;
                document.getElementById('submit-migrasi').style.opacity = '0.5';
                document.getElementById('submit-migrasi').style.cursor = 'not-allowed';
            } else {
                alreadyMigratedWarning.classList.add('hidden');
                document.getElementById('submit-migrasi').disabled = false;
                document.getElementById('submit-migrasi').style.opacity = '1';
                document.getElementById('submit-migrasi').style.cursor = 'pointer';
            }
            
            // VALIDASI 2: Cek nomor WA berbeda
            const phoneMismatchWarning = document.getElementById('phone-mismatch-warning');
            
            // Format phone untuk comparison
            let phoneLama = selectedCustomerLama.phone || '';
            let phoneBaru = selectedCustomerBaru.nomorWA || '';
            
            // Normalize phone numbers
            phoneLama = phoneLama.replace('+62', '62').replace(/^0/, '62');
            phoneBaru = phoneBaru.replace('+62', '62').replace(/^0/, '62');
            
            if (phoneLama !== phoneBaru) {
                document.getElementById('warning-phone-lama').textContent = selectedCustomerLama.phone || '-';
                document.getElementById('warning-phone-baru').textContent = selectedCustomerBaru.nomorWA || '-';
                phoneMismatchWarning.classList.remove('hidden');
            } else {
                phoneMismatchWarning.classList.add('hidden');
            }
            
            // Show warning section jika ada warning
            const warningSection = document.getElementById('migrasi-warning');
            if (alreadyMigratedWarning.classList.contains('hidden') && 
                phoneMismatchWarning.classList.contains('hidden')) {
                warningSection.classList.add('hidden');
            } else {
                warningSection.classList.remove('hidden');
            }
            
            // Show comparison section
            document.getElementById('comparison-section').classList.remove('hidden');
        }
        
        // 12. SUBMIT MIGRASI (Dengan validasi)
        async function submitMigrasi() {
            if (!selectedCustomerLama || !selectedCustomerBaru) {
                showToast('warning', 'Data belum lengkap', 'Pilih customer lama dan customer baru terlebih dahulu');
                return;
            }
            
            // VALIDASI 1: Status sudah migrasi
            if (selectedCustomerLama.status_migrasi === 'Sudah Migrasi') {
                showToast('error', 'Tidak dapat migrasi', 'Customer lama sudah melakukan migrasi sebelumnya');
                return;
            }
            
            // VALIDASI 2: Konfirmasi jika nomor WA berbeda
            let phoneLama = selectedCustomerLama.phone || '';
            let phoneBaru = selectedCustomerBaru.nomorWA || '';
            
            // Normalize phone numbers
            phoneLama = phoneLama.replace('+62', '62').replace(/^0/, '62');
            phoneBaru = phoneBaru.replace('+62', '62').replace(/^0/, '62');
            
            if (phoneLama !== phoneBaru) {
                const confirmMessage = `Nomor WA berbeda:\n\n` +
                    `Lama: ${selectedCustomerLama.phone}\n` +
                    `Baru: ${selectedCustomerBaru.nomorWA}\n\n` +
                    `Apakah Anda yakin akan melanjutkan migrasi?`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
            }
            
            // Calculate new points
            const loyaltyPoints = parseFloat(selectedCustomerLama.loyalty_points) || 0;
            const newPoints = Math.ceil(loyaltyPoints / konversiPointValue);
            const currentPoints = parseInt(selectedCustomerBaru.point) || 0;
            const updatedPoints = currentPoints + newPoints;
            
            // Final confirmation
            if (!confirm(`Konfirmasi Migrasi:\n\n` +
                `Customer Lama: ${selectedCustomerLama.name}\n` +
                `Customer Baru: ${selectedCustomerBaru.nama}\n` +
                `Point Lama: ${loyaltyPoints}\n` +
                `Konversi: ${konversiPointValue}\n` +
                `Point Baru: ${newPoints}\n` +
                `Total Point: ${updatedPoints}\n\n` +
                `Lanjutkan migrasi?`)) {
                return;
            }
            
            showLoading('Memproses migrasi...');
            
            try {
                // 1. Update membercard.point
                const { error: error1 } = await supabase
                    .from('membercard')
                    .update({ 
                        point: updatedPoints,
                        point_sebelum: currentPoints,
                        point_saat_ini: updatedPoints
                    })
                    .eq('id', selectedCustomerBaru.id);
                
                if (error1) throw error1;
                
                // 2. Update membercard_olsera dengan migration data
                const migrationData = {
                    outlet: selectedOutlet,
                    id_member: selectedCustomerBaru.id_member,
                    nama: selectedCustomerBaru.nama,
                    nomor_wa: selectedCustomerBaru.nomorWA,
                    kasir: selectedKasir,
                    konversi_point: konversiPointValue,
                    status_migrasi: 'Sudah Migrasi',
                    tanggal_migrasi: new Date().toISOString(),
                    point_migrasi: newPoints
                };
                
                const { error: error2 } = await supabase
                    .from('membercard_olsera')
                    .update(migrationData)
                    .eq('id', selectedCustomerLama.id);
                
                if (error2) throw error2;
                
                // 3. Send WhatsApp notification
                await sendWhatsAppNotification(selectedCustomerBaru.nomorWA, selectedCustomerBaru.nama, newPoints, updatedPoints);
                
                // 4. Show success message
                showToast('success', 'Migrasi berhasil', 
                    `Point baru: ${newPoints} (Total: ${updatedPoints}) telah ditambahkan ke membercard ${selectedCustomerBaru.nama}`);
                
                // 5. Reset form dan update system info
                resetMigrasiForm();
                await loadSystemInfo();
                
                // 6. Close modal after 3 seconds
                setTimeout(() => {
                    closeModalMigrasi();
                }, 3000);
                
            } catch (error) {
                console.error('Error submitting migrasi:', error);
                showToast('error', 'Gagal melakukan migrasi', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // 13. SEND WHATSAPP NOTIFICATION
        async function sendWhatsAppNotification(nomorWA, nama, pointBaru, totalPoint) {
            try {
                let chatId = nomorWA.toString().trim();
                
                // Convert to proper format: 62xxxxxxxxxx@c.us
                if (chatId.startsWith('+62')) {
                    chatId = chatId.substring(1);
                } else if (chatId.startsWith('08')) {
                    chatId = '62' + chatId.substring(1);
                } else if (chatId.startsWith('628')) {
                    // Already in correct format
                } else {
                    chatId = '62' + chatId;
                }
                
                if (!chatId.endsWith('@c.us')) {
                    chatId += '@c.us';
                }
                
                const message = `Selamat membercard Babeh Barbershop anda telah berhasil dimigrasi!\n\n` +
                               `Nama: ${nama}\n` +
                               `Point migrasi: ${pointBaru} point\n` +
                               `Total point sekarang: ${totalPoint} point\n\n` +
                               `Terima kasih telah menjadi member setia Babeh Barbershop!\n\n` +
                               `Informasi lebih lanjut:\n` +
                               `Head Office: Jl. Abdul Ghani, Rempoa, Ciputat\n` +
                               `Contact: WA 0822-1001-7083`;
                
                const response = await fetch(WAHA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': WAHA_API_KEY
                    },
                    body: JSON.stringify({
                        session: 'session3',
                        chatId: chatId,
                        text: message
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('WhatsApp notification sent successfully');
                } else {
                    console.warn('Failed to send WhatsApp notification:', result);
                }
                
            } catch (error) {
                console.error('Error sending WhatsApp notification:', error);
            }
        }
        
        // =================== FUNGSI BANTUAN ===================
        
        // PAGINATION
        function generatePagination(containerId, currentPage, totalCount, itemsPerPage, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (!totalCount || totalCount <= itemsPerPage) return;
            
            const totalPages = Math.ceil(totalCount / itemsPerPage);
            const maxVisiblePages = 5;
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.textContent = '«';
            prevButton.className = 'pagination-btn';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = function() {
                if (currentPage > 1) {
                    if (type === 'search') {
                        currentSearchPage--;
                        loadSearchResultsPage();
                    }
                }
            };
            container.appendChild(prevButton);
            
            // Page numbers
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageButton.onclick = function() {
                    if (type === 'search') {
                        currentSearchPage = i;
                        loadSearchResultsPage();
                    }
                };
                container.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.textContent = '»';
            nextButton.className = 'pagination-btn';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = function() {
                if (currentPage < totalPages) {
                    if (type === 'search') {
                        currentSearchPage++;
                        loadSearchResultsPage();
                    }
                }
            };
            container.appendChild(nextButton);
            
            // Page info
            const pageInfo = document.createElement('span');
            pageInfo.textContent = ` Hal ${currentPage} dari ${totalPages} (Total: ${totalCount})`;
            pageInfo.className = 'ml-3 text-sm text-gray-600';
            container.appendChild(pageInfo);
        }
        
        // LOAD SEARCH RESULTS PAGE
        async function loadSearchResultsPage() {
            showLoading('Memuat halaman...');
            
            try {
                let query;
                const from = (currentSearchPage - 1) * 10;
                const to = from + 9;
                
                if (searchType === 'customer-lama') {
                    const searchTerm = document.getElementById('search-customer-lama').value.trim();
                    query = supabase
                        .from('membercard_olsera')
                        .select('*', { count: 'exact' })
                        .eq('outlet', selectedOutlet)
                        .or(`name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,code.ilike.%${searchTerm}%`)
                        .range(from, to)
                        .order('name');
                } else {
                    const searchTerm = document.getElementById('search-customer-baru').value.trim();
                    query = supabase
                        .from('membercard')
                        .select('*', { count: 'exact' })
                        .eq('outlet', selectedOutlet)
                        .or(`nama.ilike.%${searchTerm}%,nomorWA.ilike.%${searchTerm}%,id_member.ilike.%${searchTerm}%`)
                        .range(from, to)
                        .order('nama');
                }
                
                const { data, error, count } = await query;
                
                if (error) throw error;
                
                searchResults = data;
                displaySearchResults(data, count, searchType);
                
            } catch (error) {
                console.error('Error loading search results page:', error);
                showToast('error', 'Gagal memuat halaman', error.message);
            } finally {
                hideLoading();
            }
        }
        
        // RESET MIGRASI FORM
        function resetMigrasiForm() {
            selectedCustomerLama = null;
            selectedCustomerBaru = null;
            
            document.getElementById('customer-lama-result').classList.add('hidden');
            document.getElementById('customer-baru-result').classList.add('hidden');
            document.getElementById('customer-baru-auto').classList.add('hidden');
            document.getElementById('comparison-section').classList.add('hidden');
            document.getElementById('migrasi-warning').classList.add('hidden');
            document.getElementById('already-migrated-warning').classList.add('hidden');
            document.getElementById('phone-mismatch-warning').classList.add('hidden');
            
            document.getElementById('search-customer-lama').value = '';
            document.getElementById('search-customer-baru').value = '';
            
            document.getElementById('submit-migrasi').disabled = false;
            document.getElementById('submit-migrasi').style.opacity = '1';
            document.getElementById('submit-migrasi').style.cursor = 'pointer';
        }
        
        // MODAL FUNCTIONS
        function openModalMigrasi() {
            if (!selectedOutlet || !selectedKasir) {
                showToast('warning', 'Pilih outlet dan kasir terlebih dahulu', 'Silakan pilih outlet dan kasir sebelum melakukan migrasi');
                return;
            }
            
            modalMigrasi.classList.remove('hidden');
            document.getElementById('migrasi-outlet').textContent = outletSelect.options[outletSelect.selectedIndex].text;
            document.getElementById('migrasi-kasir').textContent = kasirSelect.options[kasirSelect.selectedIndex].text;
            
            resetMigrasiForm();
        }
        
        function closeModalMigrasi() {
            modalMigrasi.classList.add('hidden');
        }
        
        function closeModalSearchResults() {
            modalSearchResults.classList.add('hidden');
        }
        
        // TOAST NOTIFICATION (Front Layer)
        function showToast(type, title, message) {
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Set style based on type
            toast.className = '';
            toast.classList.add('toast-' + type);
            
            // Set icon
            const icon = toastIcon.querySelector('i');
            if (type === 'success') {
                icon.className = 'fas fa-check-circle text-xl text-green-500';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle text-xl text-red-500';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-triangle text-xl text-yellow-500';
            } else {
                icon.className = 'fas fa-info-circle text-xl text-blue-500';
            }
            
            // Show toast
            toast.classList.remove('hidden');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }
        
        // LOADING FUNCTIONS
        function showLoading(text) {
            loadingText.textContent = text;
            loadingOverlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }
    </script>
</body>
</html>
